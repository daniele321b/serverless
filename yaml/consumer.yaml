metadata:
  name: consumer
  labels:
    nuclio.io/project-name: ab4cf5d4-8997-4c8f-9961-3d4ba6d198d0
spec:
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-consumer:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    trigger:
      class: ""
      kind: mqtt
      url: "guest:guest@192.168.1.103:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/trafficLights
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7DQogICAgICAgIHZhciBGVU5DVElPTl9OQU1FID0gImNvbnN1bWVyIjsNCiAgICAgICAgdmFyIFNUQVRFID0gMTsgDQogICAgICAgIHZhciBjb3VudCA9IDI7IC8vIHswIHJlZCwgMSB5ZWxsb3csIDIgZ3JlZW59DQogICAgICAgICBmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrKG1zZyl7ICAgICAgDQoNCiAgICAgICAgICAgIHZhciBxID0gJ2lvdC9sb2dzJzsgLy9wYXRoDQogICAgICAgICAgICBhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxOTIuMTY4LjEuMTAzOjU2NzInKS50aGVuKGZ1bmN0aW9uKGNvbm4pIHsgLy9jb25uZWN0aW9uDQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbm4uY3JlYXRlQ2hhbm5lbCgpLnRoZW4oZnVuY3Rpb24oY2gpIHsgLy9jb25uZWN0aW9uIGNoYW5uZWwNCiAgICAgICAgICAgICAgICAgICAgdmFyIG9rID0gY2guYXNzZXJ0UXVldWUocSwge2R1cmFibGU6IGZhbHNlfSk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsNCiAgICAgICAgICAgICAgICAgICAgY2guc2VuZFRvUXVldWUocSwgQnVmZmVyLmZyb20obXNnKSk7DQogICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coIiBbeF0gU2VudCAnJXMnIiwgbXNnKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoLmNsb3NlKCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7IA0KICAgICAgICAgICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7DQogICAgICAgIH0NCg0KICAgICAgICAvL2NoYW5nZSB2YXIgc3RhdGUNCiAgICAgICBmdW5jdGlvbiBkZWNyZW1lbnRDb3VudCgpew0KICAgICAgICByZXR1cm4gY291bnQtLTsNCiAgICAgICB9DQoNCiAgICAgIGZ1bmN0aW9uIHJlc2V0Q291bnQoKXsNCiAgICAgICAgcmV0dXJuIGNvdW50ID0gMjsNCiAgICAgIH0NCg0KICAgICAgZnVuY3Rpb24gY2hhbmdlU3RhdGUoKXsNCiAgICAgICAgcmV0dXJuIFNUQVRFPTE7DQogICAgICB9DQoNCiAgICANCg0KICAgICAgICAvL2NvbnZlcnQgZnJvbSBiaW5hcnkgdG8gc3RyaW5nDQogICAgICAgIGZ1bmN0aW9uIGJpbjJzdHJpbmcoYXJyYXkpew0KICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsNCiAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpew0KICAgICAgICAgICAgcmVzdWx0Kz0gKFN0cmluZy5mcm9tQ2hhckNvZGUoYXJyYXlbaV0pKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgICAgfQ0KDQogICAgICAgIGV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7DQogICAgICAgICAgICB2YXIgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOyAvL2Zyb20gSlNPTiB0byBqcyB2YWx1ZQ0KICAgICAgICAgICAgdmFyIF9kYXRhID0gYmluMnN0cmluZyhfZXZlbnQuYm9keS5kYXRhKTsNCiAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrICIrX2RhdGEpOw0KICAgICAgICAgICAgLy9jb250ZXh0LmNhbGxiYWNrKFNUQVRFICsgIiAtIFRMIik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vc2VuZF9mZWVkYmFjaygiQ0FMTCBNQURFICIgKyBfZGF0YSk7DQogICAgICAgICAgICAvL3NlbmRfZmVlZGJhY2soIkNBTEwgTUFERSEiKTsNCg0KICAgICAgICAgICAgaWYoU1RBVEU9PTEpew0KICAgICAgICAgICAgICBzZW5kX2ZlZWRiYWNrKCJDQUxMIE1BREUhIik7DQogICAgICAgICAgICAgIFNUQVRFLS07DQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICAgICAgZGVjcmVtZW50Q291bnQoKSwgc2VuZF9mZWVkYmFjaygiVFJBRkZJQ0xJR0hUIFNUQVRFIENIQU5HRUQgLS0tIE5PVzogWUVMTE9XICIpOw0KICAgICAgICAgICAgICB9LCA1MDAwKTsNCg0KICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICAgICAgICBkZWNyZW1lbnRDb3VudCgpLCBzZW5kX2ZlZWRiYWNrKCJUUkFGRklDTElHSFQgU1RBVEUgQ0hBTkdFRCAtLS0gTk9XOiBSRUQgIik7DQogICAgICAgICAgICAgIH0sIDE1MDAwKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICAgICAgICByZXNldENvdW50KCksIHNlbmRfZmVlZGJhY2soIlRSQUZGSUNMSUdIVCBTVEFURSBSRVNFVCAtLS0gTk9XOiBHUkVFTiAiKTsNCiAgICAgICAgICAgICAgfSwgMzAwMDApOw0KDQogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgICAgICAgIGNoYW5nZVN0YXRlKCkNCiAgICAgICAgICAgICAgfSwgMzAwMTApOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICA=
    commands:
      - 'npm install amqplib'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
  version: 1
